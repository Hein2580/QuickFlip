<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Your Plan - QuickFlip</title>
    <link rel="stylesheet" href="assets/css/style.css?v=2">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="assets/js/alpine-stores.js"></script>
</head>
<body x-data="subscriptionSelection()" x-init="init()">
    <header>
        <h1>üöÄ QuickFlip Subscription Plans</h1>
        <p>Choose the perfect plan for your business needs</p>
    </header>

    <main style="max-width: 900px; margin: 2rem auto;">
        <div class="form-section">
            <h2 style="text-align: center; margin-bottom: 2rem;">Select Your Subscription Plan</h2>
            
            <!-- Plan Selection -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                
                <!-- Monthly Plan -->
                <div class="plan-card" :class="{ 'selected': selectedPlan && selectedPlan.id === 1 }" 
                     @click="selectPlan($store.subscription.plans[0])">
                    <div class="plan-header">
                        <h3>Monthly Plan</h3>
                        <div class="plan-price">
                            <span class="currency">$</span>
                            <span class="amount">49</span>
                            <span class="period">/month</span>
                        </div>
                    </div>
                    
                    <div class="plan-description">
                        <p>Perfect for small businesses with monthly invoice processing</p>
                    </div>
                    
                    <div class="plan-features">
                        <ul>
                            <li>‚úÖ Up to 50 invoices/month</li>
                            <li>‚úÖ Basic analytics</li>
                            <li>‚úÖ Email support</li>
                            <li>‚úÖ 5% discount rate</li>
                            <li>‚úÖ Standard processing time</li>
                        </ul>
                    </div>
                    
                    <button type="button" class="btn-secondary" style="width: 100%; margin-top: 1rem;"
                            :class="{ 'btn-primary': selectedPlan && selectedPlan.id === 1 }">
                        <span x-show="!selectedPlan || selectedPlan.id !== 1">Select Monthly</span>
                        <span x-show="selectedPlan && selectedPlan.id === 1">‚úì Selected</span>
                    </button>
                </div>

                <!-- Yearly Plan -->
                <div class="plan-card recommended" :class="{ 'selected': selectedPlan && selectedPlan.id === 2 }" 
                     @click="selectPlan($store.subscription.plans[1])">
                    <div class="plan-badge">üèÜ RECOMMENDED</div>
                    
                    <div class="plan-header">
                        <h3>Yearly Plan</h3>
                        <div class="plan-price">
                            <span class="currency">$</span>
                            <span class="amount">490</span>
                            <span class="period">/year</span>
                        </div>
                        <div class="plan-savings">Save $98 per year!</div>
                    </div>
                    
                    <div class="plan-description">
                        <p>Best value for growing businesses with annual commitment</p>
                    </div>
                    
                    <div class="plan-features">
                        <ul>
                            <li>‚úÖ Unlimited invoices</li>
                            <li>‚úÖ Advanced analytics</li>
                            <li>‚úÖ Priority support</li>
                            <li>‚úÖ 8% discount rate</li>
                            <li>‚úÖ Priority processing</li>
                            <li>üéÅ 2 months free</li>
                        </ul>
                    </div>
                    
                    <button type="button" class="btn-secondary" style="width: 100%; margin-top: 1rem;"
                            :class="{ 'btn-primary': selectedPlan && selectedPlan.id === 2 }">
                        <span x-show="!selectedPlan || selectedPlan.id !== 2">Select Yearly</span>
                        <span x-show="selectedPlan && selectedPlan.id === 2">‚úì Selected</span>
                    </button>
                </div>
            </div>

            <!-- Selected Plan Summary -->
            <div x-show="selectedPlan" class="form-section" style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem;">
                <h3>Plan Summary</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span x-text="selectedPlan?.name"></span>
                    <strong x-text="'$' + selectedPlan?.price + '/' + selectedPlan?.interval"></strong>
                </div>
                <p x-text="selectedPlan?.description" style="color: #666; margin: 0;"></p>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn-secondary" @click="goBack()">
                    ‚Üê Back to Business Intake
                </button>
                <button type="button" class="btn-primary" 
                        :disabled="!selectedPlan || isProcessing"
                        @click="confirmSubscription()">
                    <span x-show="!isProcessing">Continue to Dashboard ‚Üí</span>
                    <span x-show="isProcessing">Processing...</span>
                </button>
            </div>
        </div>
    </main>

    <style>
        .plan-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: white;
        }

        .plan-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .plan-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
            background: #f0f9ff;
        }

        .plan-card.recommended {
            border-color: #f59e0b;
        }

        .plan-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.25rem 1rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .plan-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .plan-header h3 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.5rem;
        }

        .plan-price {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.25rem;
        }

        .plan-price .currency {
            font-size: 1.25rem;
            color: #6b7280;
        }

        .plan-price .amount {
            font-size: 3rem;
            font-weight: 700;
            color: #1f2937;
        }

        .plan-price .period {
            font-size: 1rem;
            color: #6b7280;
        }

        .plan-savings {
            margin-top: 0.5rem;
            color: #059669;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .plan-description {
            margin-bottom: 1.5rem;
        }

        .plan-description p {
            color: #6b7280;
            text-align: center;
            margin: 0;
        }

        .plan-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .plan-features li {
            padding: 0.5rem 0;
            color: #374151;
        }

        @media (max-width: 768px) {
            main {
                margin: 1rem;
                max-width: none;
            }
            
            .plan-card {
                padding: 1rem;
            }
            
            .plan-price .amount {
                font-size: 2.5rem;
            }
        }
    </style>

    <script>
        function subscriptionSelection() {
            return {
                selectedPlan: null,
                isProcessing: false,

                init() {
                    // Check if user is logged in and has completed business intake
                    const user = JSON.parse(localStorage.getItem('quickflip_user') || 'null');
                    if (!user || !user.businessIntakeDone) {
                        window.location.href = 'index.html';
                        return;
                    }

                    // Initialize subscription store
                    this.$store.subscription.init();
                },

                selectPlan(plan) {
                    this.selectedPlan = plan;
                    this.$store.subscription.selectPlan(plan);
                },

                async confirmSubscription() {
                    if (!this.selectedPlan) {
                        await this.$store.ui.showAlert('Please select a subscription plan');
                        return;
                    }

                    this.isProcessing = true;

                    try {
                        // Simulate API call for subscription
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        // Save subscription
                        const result = this.$store.subscription.subscribeToPlan();
                        
                        if (result.success) {
                            // Update user with subscription status
                            const user = JSON.parse(localStorage.getItem('quickflip_user') || '{}');
                            user.subscriptionActive = true;
                            user.subscriptionPlan = this.selectedPlan;
                            localStorage.setItem('quickflip_user', JSON.stringify(user));

                            await this.$store.ui.showAlert(`Welcome to QuickFlip! Your ${this.selectedPlan.name} is now active. Redirecting to dashboard...`, 'Subscription Activated');
                            
                            setTimeout(() => {
                                window.location.href = 'buyer.html';
                            }, 1500);
                        } else {
                            await this.$store.ui.showAlert(result.message || 'Subscription failed. Please try again.');
                        }
                    } catch (error) {
                        await this.$store.ui.showAlert('Network error. Please try again.');
                    } finally {
                        this.isProcessing = false;
                    }
                },

                goBack() {
                    window.location.href = 'business-intake.html';
                }
            }
        }
    </script>
</body>
</html>
